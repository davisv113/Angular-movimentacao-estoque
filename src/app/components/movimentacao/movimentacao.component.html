<div class="p-6">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-1">
      <div class="bg-white p-6 rounded-xl border border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
          <span class="material-symbols-outlined text-indigo-600">add_circle</span>
          Lançamento
        </h2>

        <form
          [formGroup]="estoqueForm"
          (ngSubmit)="lancarMovimentacao()"
          class="flex flex-col gap-4"
        >
          <label class="block text-sm text-gray-600">Produto</label>
          <select
            formControlName="produto"
            (change)="onProdutoChange()"
            class="border rounded p-2 bg-gray-50 w-full"
          >
            <option [ngValue]="null">-- selecione --</option>
            @for (prod of produtos(); track prod.codigoProduto) {
              <option [ngValue]="prod">
                {{ prod.descricaoProduto }}
              </option>
            }
          </select>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600">Quantidade</label>
              <input
                type="number"
                formControlName="qtdeRaw"
                class="border rounded p-2 w-full"
                placeholder="0"
              />
            </div>

            <div>
              <label class="block text-sm text-gray-600">Unidade</label>
              <select
                formControlName="unidadeSelecionada"
                class="border rounded p-2 bg-gray-50 w-full"
              >
                <option [ngValue]="null">--</option>
                @for (uni of unidadesDisponiveis(); track uni.unidade) {
                  <option [ngValue]="uni">
                    {{ uni.unidade }} (x{{ uni.fator }})
                  </option>
                }
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm text-gray-600">Tipo de Operação</label>
            <select formControlName="tipoOperacao" class="border rounded p-2 w-full">
              <option value="entrada">Entrada (+)</option>
              <option value="saida">Saída (-)</option>
            </select>
          </div>

          <div>
            <label class="block text-sm text-gray-600">Data</label>
            <input type="date" formControlName="data" class="border rounded p-2 w-full" />
          </div>

          <div>
            <label class="block text-sm text-gray-600">Descrição</label>
            <textarea
              formControlName="descricao"
              rows="2"
              class="border rounded p-2 w-full"
              placeholder="Ex: NF 1234 - Reposição"
            ></textarea>
          </div>

          <button
            type="submit"
            [disabled]="estoqueForm.invalid"
            class="w-full py-3 text-white rounded-lg bg-indigo-600 hover:bg-indigo-700 transition"
          >
            Confirmar
          </button>
        </form>
      </div>
    </div>

    <div class="lg:col-span-2 flex flex-col h-full">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
        <h2 class="text-xl font-semibold text-gray-800">Histórico de Movimentações</h2>

        <div class="flex items-center gap-2 w-full sm:w-72">
          <input
            (keyup)="aplicarFiltro($event)"
            placeholder="Filtrar registros"
            class="border rounded p-2 w-full bg-gray-50"
          />
          <button class="p-2 rounded bg-gray-100 hover:bg-gray-200">
            <span class="material-symbols-outlined">search</span>
          </button>
        </div>
      </div>

      <div class="border rounded-lg overflow-hidden flex-grow shadow-sm">
        @if (notification()) {
          <div class="p-3 text-white bg-green-600">{{ notification() }}</div>
        }

        @if (displayed().length === 0) {
          <div class="p-8 text-center text-gray-500">
            Nenhuma movimentação encontrada para o filtro
          </div>
        }

        @if (displayed().length > 0) {
          <div class="w-full">
            <table class="w-full table-fixed">
              <thead class="bg-gray-100 text-sm text-gray-700">
                <tr>
                  <th class="p-3 text-left w-24 font-medium">ID</th>
                  <th class="p-3 text-left font-medium">Data</th>
                  <th class="p-3 text-left font-medium">Produto</th>
                  <th class="p-3 text-left font-medium">Descrição</th>
                  <th class="p-3 text-right font-medium">Qtde</th>
                  <th class="p-3 text-center font-medium w-28">Ações</th>
                </tr>
              </thead>
              <tbody>
                @for (row of displayed(); track row.id) {
                  <tr class="border-t hover:bg-gray-50">
                    <td class="p-3 text-xs text-gray-500 font-mono">{{ row.id | slice : 0 : 8 }}</td>
                    <td class="p-3">{{ row.data | date : 'dd/MM/yyyy' }}</td>
                    <td class="p-3">
                      <div class="flex flex-col">
                        <span class="font-medium text-gray-800">{{ row.descricaoProduto }}</span>
                        <span class="text-xs text-gray-400">Cód: {{ row.codigoProduto }}</span>
                        @if (row.estornado) {
                          <div class="mt-1 inline-block text-xs text-red-700 bg-red-50 px-2 py-0.5 rounded-full font-semibold">
                            ESTORNADO
                          </div>
                        }
                        @if (row.tipo === 'Estorno') {
                          <div class="mt-1 inline-block text-xs text-gray-700 bg-gray-100 px-2 py-0.5 rounded-full font-semibold">
                            ESTORNO
                          </div>
                        }
                      </div>
                    </td>
                    <td class="p-3">{{ row.descricaoUsuario }}</td>
                    <td
                      class="p-3 text-right font-bold"
                      [ngClass]="{
                        'text-green-600': row.qtde > 0,
                        'text-red-600': row.qtde < 0,
                        'text-gray-500': row.qtde === 0
                      }"
                    >
                      {{ row.qtde > 0 ? '+' : '' }}{{ row.qtde }}
                    </td>
                    <td class="p-3 text-center">
                      <button
                        (click)="estornarMovimentacao(row)"
                        [disabled]="row.tipo === 'Estorno' || row.estornado || row.estornadoDe"
                        class="px-2 py-1 rounded bg-red-50 text-red-600 hover:bg-red-100 disabled:opacity-40"
                      >
                        Estornar
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>

            <div class="flex items-center justify-between p-3 border-t bg-white">
              <div class="text-sm text-gray-500">Página {{ page() + 1 }} / {{ totalPages() }}</div>
              <div class="flex gap-2">
                <button
                  (click)="prevPage()"
                  [disabled]="page() === 0"
                  class="px-3 py-1 rounded border"
                >
                  Anterior
                </button>
                <button
                  (click)="nextPage()"
                  [disabled]="page() + 1 >= totalPages()"
                  class="px-3 py-1 rounded border"
                >
                  Próxima
                </button>
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>
